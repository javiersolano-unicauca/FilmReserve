--DDL

CREATE DATABASE filmreserve;

CREATE TABLE user (
	identification BIGINT NOT NULL,
	first_name VARCHAR(50) NOT NULL,
	second_name VARCHAR(50) NULL,
	first_surname VARCHAR(50) NOT NULL,
	second_surname VARCHAR(50) NULL,
	password VARCHAR(255) NOT NULL,
	administrator BOOLEAN NOT NULL DEFAULT false,
	avatar VARCHAR(50) NOT NULL,
	CONSTRAINT pk_identification PRIMARY KEY(identification)

)ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE customer (
	identification BIGINT NOT NULL,
	day INT(2) NOT NULL,
	month INT(2) NOT NULL,
	year INT(4) NOT NULL,
	phone BIGINT(10) NOT NULL,
	CONSTRAINT pk_identification PRIMARY KEY(identification),
	CONSTRAINT fk_user FOREIGN KEY(identification) REFERENCES user(identification) ON DELETE CASCADE,
	CONSTRAINT ck_day CHECK(day >= 1 AND day <= 31),
	CONSTRAINT ck_month CHECK(month >= 1 AND month <= 12),
	CONSTRAINT ck_year CHECK(year >= 1924),
	CONSTRAINT ck_phone CHECK(phone > 0)

)ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE membership (
	identification BIGINT NOT NULL,
	start_date DATE NOT NULL,
	end_date DATE NOT NULL,
	active BOOLEAN NOT NULL DEFAULT true,
	reference_id VARCHAR(100) NOT NULL,
	payment_id BIGINT NOT NULL,
	CONSTRAINT pk_membership PRIMARY KEY(identification, start_date),
	CONSTRAINT fk_customer FOREIGN KEY(identification) REFERENCES customer(identification) ON DELETE CASCADE

)ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE ticket_seller (
	identification BIGINT NOT NULL,
	turn VARCHAR(5) NOT NULL,
	CONSTRAINT pk_identification PRIMARY KEY(identification),
	CONSTRAINT fk_user1 FOREIGN KEY(identification) REFERENCES user(identification) ON DELETE CASCADE,
	CONSTRAINT ck_turn CHECK(turn in ('TARDE', 'NOCHE'))

)ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE movie (
	id_movie BIGINT NOT NULL,
	name VARCHAR(50) NOT NULL,
	sypnosis VARCHAR(300) NOT NULL,
	poster_image VARCHAR(100) NOT NULL,
	CONSTRAINT pk_id_movie PRIMARY KEY(id_movie)

)ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE gender(
	id_movie BIGINT NOT NULL,
	name VARCHAR(20) NOT NULL,
	CONSTRAINT pk_gender PRIMARY KEY(id_movie, name),
	CONSTRAINT fk_movie FOREIGN KEY(id_movie) REFERENCES movie(id_movie) ON DELETE CASCADE

)ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- Se aniaden asientos y funciones

CREATE TABLE seat(
	cinema_room INT(2) NOT NULL,
	row CHAR(1) NOT NULL,
	num_column INT(2) NOT NULL,
	CONSTRAINT pk_seat PRIMARY KEY(cinema_room, row, num_column)
	
)ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE function(
	id_movie BIGINT NOT NULL,
	start_date DATE NOT NULL,
	start_time TIME NOT NULL,
	end_time TIME NOT NULL,
	active BOOLEAN NOT NULL DEFAULT true,
	CONSTRAINT pk_function PRIMARY KEY(id_movie, start_date, start_time, end_time),
	CONSTRAINT fk_movie1 FOREIGN KEY(id_movie) REFERENCES movie(id_movie) ON DELETE CASCADE

)ENGINE=InnoDB DEFAULT CHARSET=latin1;

CREATE TABLE reserve(
	id_movie BIGINT NOT NULL,
	start_date DATE NOT NULL,
	start_time TIME NOT NULL,
	end_time TIME NOT NULL,
	cinema_room INT(2) NOT NULL,
	row CHAR(1) NOT NULL,
	num_column INT(2) NOT NULL,
	reserved BOOLEAN NOT NULL DEFAULT false,
	CONSTRAINT pk_reserve PRIMARY KEY(id_movie, start_date, start_time, end_time, cinema_room, row, num_column),
	CONSTRAINT fk_function FOREIGN KEY(id_movie, start_date, start_time, end_time) REFERENCES function(id_movie, start_date, start_time, end_time) ON DELETE CASCADE,
	CONSTRAINT fk_seat FOREIGN KEY(cinema_room, row, num_column) REFERENCES seat(cinema_room, row, num_column) ON DELETE CASCADE

)ENGINE=InnoDB DEFAULT CHARSET=latin1;

-- Compras

CREATE TABLE purchase(
	identification BIGINT NOT NULL,
	id_movie BIGINT NOT NULL,
	start_date DATE NOT NULL,
	start_time TIME NOT NULL,
	end_time TIME NOT NULL,
	cinema_room INT(2) NOT NULL,
	row CHAR(1) NOT NULL,
	num_column INT(2) NOT NULL,
	reference_id VARCHAR(100) NOT NULL,
	payment_id BIGINT NOT NULL,
	value BIGINT NOT NULL,
	CONSTRAINT pk_purchase PRIMARY KEY(identification, id_movie, start_date, start_time, end_time, cinema_room, row, num_column, reference_id),
	CONSTRAINT fk_customer1 FOREIGN KEY(identification) REFERENCES customer(identification) ON DELETE CASCADE,
	CONSTRAINT fk_reserve FOREIGN KEY(id_movie, start_date, start_time, end_time, cinema_room, row, num_column) REFERENCES reserve(id_movie, start_date, start_time, end_time, cinema_room, row, num_column) ON DELETE CASCADE,
	CONSTRAINT fk_value CHECK(value > 0),
	CONSTRAINT ck_payment_id CHECK(payment_id > 0),
	CONSTRAINT ck_amount_seats CHECK(amount_seats > 0)

)ENGINE=InnoDB DEFAULT CHARSET=latin1;
	
-- Ventas

CREATE TABLE sell(
	identification BIGINT NOT NULL,
	id_movie BIGINT NOT NULL,
	start_date DATE NOT NULL,
	start_time TIME NOT NULL,
	end_time TIME NOT NULL,
	cinema_room INT(2) NOT NULL,
	row CHAR(1) NOT NULL,
	num_column INT(2) NOT NULL,
	value BIGINT NOT NULL,
	CONSTRAINT pk_sell PRIMARY KEY(identification, id_movie, start_date, start_time, end_time, cinema_room, row, num_column),
	CONSTRAINT fk_ticket_seller FOREIGN KEY(identification) REFERENCES ticket_seller(identification) ON DELETE CASCADE,
	CONSTRAINT fk_reserve1 FOREIGN KEY(id_movie, start_date, start_time, end_time, cinema_room, row, num_column) REFERENCES reserve(id_movie, start_date, start_time, end_time, cinema_room, row, num_column) ON DELETE CASCADE,
	CONSTRAINT fk_value CHECK(value > 0),
	CONSTRAINT ck_amount_seats CHECK(amount_seats > 0)

)ENGINE=InnoDB DEFAULT CHARSET=latin1;
